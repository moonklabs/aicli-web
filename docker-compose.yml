version: '3.8'

services:
  # CLI ê°œë°œ í™˜ê²½
  aicli-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: aicli-dev
    volumes:
      # ì†ŒìŠ¤ ì½”ë“œ ë§ˆìš´íŠ¸
      - .:/workspace:cached
      # Go ëª¨ë“ˆ ìºì‹œ (ì„±ëŠ¥ ìµœì í™”)
      - go-mod-cache:/go/pkg/mod
      # ë¹Œë“œ ìºì‹œ
      - go-build-cache:/root/.cache/go-build
    working_dir: /workspace
    command: air -c .air.cli.toml
    environment:
      - GO_ENV=development
      - CGO_ENABLED=1
      - LOG_LEVEL=debug
    networks:
      - aicli-network
    # CLIëŠ” ëŒ€í™”í˜• ëª¨ë“œë¡œ ì‹¤í–‰
    stdin_open: true
    tty: true

  # API ì„œë²„ ê°œë°œ í™˜ê²½
  api-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: api-dev
    volumes:
      # ì†ŒìŠ¤ ì½”ë“œ ë§ˆìš´íŠ¸
      - .:/workspace:cached
      # Go ëª¨ë“ˆ ìºì‹œ (ì„±ëŠ¥ ìµœì í™”)
      - go-mod-cache:/go/pkg/mod
      # ë¹Œë“œ ìºì‹œ
      - go-build-cache:/root/.cache/go-build
    working_dir: /workspace
    command: air -c .air.api.toml
    ports:
      # API ì„œë²„ í¬íŠ¸
      - "8080:8080"
      # Delve ë””ë²„ê±° í¬íŠ¸
      - "2345:2345"
      # pprof í”„ë¡œíŒŒì¼ëŸ¬ í¬íŠ¸
      - "6060:6060"
    environment:
      - GO_ENV=development
      - API_PORT=8080
      - DEBUG_PORT=2345
      - CGO_ENABLED=1
      - LOG_LEVEL=debug
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
    env_file:
      - .env
    networks:
      - aicli-network
    depends_on:
      - workspace-prep

  # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì¤€ë¹„ ì„œë¹„ìŠ¤ (ì´ˆê¸°í™”ìš©)
  workspace-prep:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: workspace-prep
    volumes:
      - .:/workspace:cached
      - go-mod-cache:/go/pkg/mod
    working_dir: /workspace
    command: |
      bash -c "
        echo 'ğŸš€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...'
        if [ ! -f go.mod ]; then
          echo 'go.mod íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì´ˆê¸°í™”í•˜ì„¸ìš”.'
          exit 1
        fi
        echo 'ğŸ“¦ ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ì¤‘...'
        go mod download
        echo 'âœ… ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì¤€ë¹„ ì™„ë£Œ!'
      "
    networks:
      - aicli-network

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í™˜ê²½
  test:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: aicli-test
    volumes:
      - .:/workspace:cached
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    working_dir: /workspace
    command: make test
    environment:
      - GO_ENV=test
      - CGO_ENABLED=1
    networks:
      - aicli-network
    profiles:
      - test

  # ë¦°íŒ… í™˜ê²½
  lint:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: aicli-lint
    volumes:
      - .:/workspace:cached
      - go-mod-cache:/go/pkg/mod
    working_dir: /workspace
    command: make lint
    networks:
      - aicli-network
    profiles:
      - lint

# ë³¼ë¥¨ ì •ì˜
volumes:
  # Go ëª¨ë“ˆ ìºì‹œ (ì¬ì‚¬ìš©)
  go-mod-cache:
    driver: local
  # ë¹Œë“œ ìºì‹œ (ì„±ëŠ¥ í–¥ìƒ)
  go-build-cache:
    driver: local

# ë„¤íŠ¸ì›Œí¬ ì •ì˜
networks:
  aicli-network:
    driver: bridge
    name: aicli-network