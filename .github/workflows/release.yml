name: Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'  # ì‹œë§¨í‹± ë²„ì €ë‹ íƒœê·¸ (v1.0.0, v2.1.3 ë“±)

env:
  GO_VERSION: '1.21'

jobs:
  # ë¦´ë¦¬ìŠ¤ ì „ ê²€ì¦
  pre-release-checks:
    name: Pre-release Checks
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Go í™˜ê²½ ì„¤ì •
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ§ª ë¦´ë¦¬ìŠ¤ ì „ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          go test -v -race ./...

      - name: ë¦°íŠ¸ ê²€ì‚¬
        uses: golangci/golangci-lint-action@v3
        with:
          version: v1.50.1
          args: --timeout=5m

      - name: ë³´ì•ˆ ìŠ¤ìº”
        uses: securecodewarrior/gosec-action@v1.0.0
        with:
          args: '-no-fail -fmt json -out gosec-results.json ./...'

      - name: ë²„ì „ íƒœê·¸ ê²€ì¦
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "ğŸ·ï¸ ë¦´ë¦¬ìŠ¤ íƒœê·¸: $TAG"
          
          # ì‹œë§¨í‹± ë²„ì €ë‹ í˜•ì‹ ê²€ì¦
          if ! [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âŒ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë²„ì „ íƒœê·¸ í˜•ì‹: $TAG"
            echo "âœ… ì˜¬ë°”ë¥¸ í˜•ì‹: v1.0.0, v2.1.3-beta.1, v3.0.0-rc.2+build.123"
            exit 1
          fi
          
          echo "âœ… ë²„ì „ íƒœê·¸ ê²€ì¦ í†µê³¼"

  # ë©€í‹° í”Œë«í¼ ë¹Œë“œ
  build-release:
    name: Build Release Binaries
    runs-on: ubuntu-latest
    needs: pre-release-checks
    strategy:
      matrix:
        include:
          # Linux builds
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          # macOS builds
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          # Windows builds
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Go í™˜ê²½ ì„¤ì •
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: ë¹Œë“œ ì •ë³´ ì„¤ì •
        id: build-info
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}  # v ì œê±°
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u '+%Y-%m-%d_%H:%M:%S')" >> $GITHUB_OUTPUT

      - name: ë¦´ë¦¬ìŠ¤ ë°”ì´ë„ˆë¦¬ ë¹Œë“œ
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${{ steps.build-info.outputs.version }}
          TAG=${{ steps.build-info.outputs.tag }}
          
          # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p dist
          
          # ë°”ì´ë„ˆë¦¬ ì´ë¦„ ì„¤ì •
          CLI_NAME="aicli-${TAG}-${GOOS}-${GOARCH}"
          API_NAME="aicli-api-${TAG}-${GOOS}-${GOARCH}"
          
          if [ "$GOOS" = "windows" ]; then
            CLI_NAME="${CLI_NAME}.exe"
            API_NAME="${API_NAME}.exe"
          fi
          
          # CLI ë¹Œë“œ
          echo "ğŸ“¦ Building $CLI_NAME..."
          go build -v -trimpath \
            -ldflags "-s -w -extldflags '-static' \
              -X github.com/aicli/aicli-web/pkg/version.Version=$VERSION \
              -X github.com/aicli/aicli-web/pkg/version.BuildTime=${{ steps.build-info.outputs.build_time }} \
              -X github.com/aicli/aicli-web/pkg/version.GitCommit=${{ steps.build-info.outputs.commit }} \
              -X github.com/aicli/aicli-web/pkg/version.GitBranch=main" \
            -o "dist/$CLI_NAME" \
            ./cmd/aicli
          
          # API ì„œë²„ ë¹Œë“œ
          echo "ğŸ“¦ Building $API_NAME..."
          go build -v -trimpath \
            -ldflags "-s -w -extldflags '-static' \
              -X github.com/aicli/aicli-web/pkg/version.Version=$VERSION \
              -X github.com/aicli/aicli-web/pkg/version.BuildTime=${{ steps.build-info.outputs.build_time }} \
              -X github.com/aicli/aicli-web/pkg/version.GitCommit=${{ steps.build-info.outputs.commit }} \
              -X github.com/aicli/aicli-web/pkg/version.GitBranch=main" \
            -o "dist/$API_NAME" \
            ./cmd/api
          
          # ë°”ì´ë„ˆë¦¬ í¬ê¸° í™•ì¸
          echo "ğŸ“ Binary sizes:"
          ls -lh dist/

      - name: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*
          retention-days: 1

  # ì²´í¬ì„¬ ìƒì„± ë° ë¦´ë¦¬ìŠ¤ ìƒì„±
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-release
    permissions:
      contents: write
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: release-binaries-*
          merge-multiple: true

      - name: ì²´í¬ì„¬ ìƒì„±
        run: |
          cd dist
          
          # SHA256 ì²´í¬ì„¬ ìƒì„±
          echo "ğŸ” Generating SHA256 checksums..."
          sha256sum * > checksums.txt
          
          # ì²´í¬ì„¬ íŒŒì¼ ë‚´ìš© í™•ì¸
          echo "ğŸ“‹ Checksums:"
          cat checksums.txt
          
          # ê° íŒŒì¼ë³„ ê°œë³„ ì²´í¬ì„¬ íŒŒì¼ë„ ìƒì„±
          for file in $(ls | grep -v checksums.txt); do
            sha256sum "$file" > "$file.sha256"
          done

      - name: ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
        id: release-notes
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          
          # ì´ì „ íƒœê·¸ ì°¾ê¸°
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || echo "")
          
          # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ í—¤ë”
          cat > release-notes.md << EOF
          # AICode Manager $TAG ë¦´ë¦¬ìŠ¤
          
          ğŸ“… ë¦´ë¦¬ìŠ¤ ë‚ ì§œ: $(date -u '+%Yë…„ %mì›” %dì¼')
          
          ## ğŸš€ ì£¼ìš” ë³€ê²½ì‚¬í•­
          
          EOF
          
          # ì»¤ë°‹ ë¡œê·¸ ê¸°ë°˜ ë³€ê²½ì‚¬í•­ ì¶”ê°€
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "### ğŸ“ ë³€ê²½ ë‚´ì—­ ($PREVIOUS_TAG â†’ $TAG)" >> release-notes.md
            echo "" >> release-notes.md
            
            # ì»¤ë°‹ ë©”ì‹œì§€ ë¶„ë¥˜
            git log $PREVIOUS_TAG..$TAG --pretty=format:"- %s" | while read -r line; do
              if [[ "$line" =~ ^-\ feat:* ]]; then
                echo "âœ¨ $line" >> release-notes.md
              elif [[ "$line" =~ ^-\ fix:* ]]; then
                echo "ğŸ› $line" >> release-notes.md
              elif [[ "$line" =~ ^-\ docs:* ]]; then
                echo "ğŸ“š $line" >> release-notes.md
              elif [[ "$line" =~ ^-\ chore:* ]]; then
                echo "ğŸ”§ $line" >> release-notes.md
              elif [[ "$line" =~ ^-\ refactor:* ]]; then
                echo "â™»ï¸ $line" >> release-notes.md
              else
                echo "$line" >> release-notes.md
              fi
            done
          else
            echo "ğŸ‰ ì²« ë²ˆì§¸ ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤!" >> release-notes.md
          fi
          
          # ì„¤ì¹˜ ê°€ì´ë“œ ì¶”ê°€
          cat >> release-notes.md << EOF
          
          ## ğŸ“¥ ì„¤ì¹˜ ë°©ë²•
          
          ### macOS (Intel)
          \`\`\`bash
          curl -L https://github.com/aicli/aicli-web/releases/download/$TAG/aicli-$TAG-darwin-amd64 -o aicli
          chmod +x aicli
          sudo mv aicli /usr/local/bin/
          \`\`\`
          
          ### macOS (Apple Silicon)
          \`\`\`bash
          curl -L https://github.com/aicli/aicli-web/releases/download/$TAG/aicli-$TAG-darwin-arm64 -o aicli
          chmod +x aicli
          sudo mv aicli /usr/local/bin/
          \`\`\`
          
          ### Linux (x64)
          \`\`\`bash
          curl -L https://github.com/aicli/aicli-web/releases/download/$TAG/aicli-$TAG-linux-amd64 -o aicli
          chmod +x aicli
          sudo mv aicli /usr/local/bin/
          \`\`\`
          
          ### Windows
          PowerShellì—ì„œ ì‹¤í–‰:
          \`\`\`powershell
          Invoke-WebRequest -Uri "https://github.com/aicli/aicli-web/releases/download/$TAG/aicli-$TAG-windows-amd64.exe" -OutFile "aicli.exe"
          \`\`\`
          
          ## ğŸ” ì²´í¬ì„¬ ê²€ì¦
          
          ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì˜ ë¬´ê²°ì„±ì„ í™•ì¸í•˜ë ¤ë©´:
          \`\`\`bash
          # macOS/Linux
          sha256sum -c checksums.txt
          
          # ë˜ëŠ” ê°œë³„ íŒŒì¼ ê²€ì¦
          sha256sum aicli-$TAG-darwin-amd64
          \`\`\`
          
          ## ğŸ”– ë²„ì „ í™•ì¸
          
          ì„¤ì¹˜ í›„ ë²„ì „ì„ í™•ì¸í•˜ë ¤ë©´:
          \`\`\`bash
          aicli version
          \`\`\`
          
          ## ğŸ“‹ ì§€ì› í”Œë«í¼
          
          | OS | Architecture | CLI Binary | API Binary |
          |---|---|---|---|
          | Linux | x64 | âœ… | âœ… |
          | Linux | ARM64 | âœ… | âœ… |
          | macOS | x64 (Intel) | âœ… | âœ… |
          | macOS | ARM64 (Apple Silicon) | âœ… | âœ… |
          | Windows | x64 | âœ… | âœ… |
          | Windows | ARM64 | âœ… | âœ… |
          
          ---
          
          **Full Changelog**: https://github.com/aicli/aicli-web/compare/$PREVIOUS_TAG...$TAG
          EOF
          
          # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ë¥¼ ì¶œë ¥ìœ¼ë¡œ ì €ì¥
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.release-notes.outputs.notes }}
          files: |
            dist/*
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}  # v1.0.0-beta ê°™ì€ ê²½ìš° pre-release
          generate_release_notes: false  # ìë™ ìƒì„± ë¹„í™œì„±í™” (ìˆ˜ë™ìœ¼ë¡œ ìƒì„±)
          fail_on_unmatched_files: true

      - name: ë¦´ë¦¬ìŠ¤ ìƒì„± ì•Œë¦¼
        if: success()
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "âœ… ë¦´ë¦¬ìŠ¤ $TAGê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ”— ë¦´ë¦¬ìŠ¤ í˜ì´ì§€: https://github.com/aicli/aicli-web/releases/tag/$TAG"

      - name: ì‹¤íŒ¨ ì‹œ ì •ë¦¬
        if: failure()
        run: |
          echo "âŒ ë¦´ë¦¬ìŠ¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."

  # Docker ì´ë¯¸ì§€ ë¦´ë¦¬ìŠ¤ (ì„ íƒì‚¬í•­)
  docker-release:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: create-release
    if: success()
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker ë©”íƒ€ë°ì´í„° ì„¤ì •
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            aicli/aicli-web
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max