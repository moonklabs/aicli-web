name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened

env:
  GO_VERSION: '1.21'
  GOLANGCI_LINT_VERSION: 'v1.50.1'

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Go í™˜ê²½ ì„¤ì •
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: golangci-lint ì‹¤í–‰
        uses: golangci/golangci-lint-action@v3
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=5m
          skip-cache: true
          skip-pkg-cache: true
          skip-build-cache: true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Go í™˜ê²½ ì„¤ì •
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ
        run: |
          go mod download
          go mod verify

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./internal/... ./pkg/...

      - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          go test -v -race -tags=integration ./test/integration/...

      - name: ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰
        run: |
          go test -v -race -tags=benchmark -run=^$$ -bench=. -benchmem ./test/benchmark/... || true

      - name: ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build Binary (${{ matrix.goos }}-${{ matrix.goarch }})
    runs-on: ${{ matrix.os }}
    needs: test
    strategy:
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          # macOS builds
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          # Windows builds
          - os: windows-latest
            goos: windows
            goarch: amd64
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Go í™˜ê²½ ì„¤ì •
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: ë¹Œë“œ ì •ë³´ ì„¤ì •
        id: build-info
        run: |
          echo "version=$(git describe --tags --always --dirty)" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u '+%Y-%m-%d_%H:%M:%S')" >> $GITHUB_OUTPUT

      - name: ë°”ì´ë„ˆë¦¬ ë¹Œë“œ
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          # ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p dist
          
          # CLI ë„êµ¬ ë¹Œë“œ
          echo "Building aicli for ${{ matrix.goos }}-${{ matrix.goarch }}..."
          go build -v -trimpath \
            -ldflags "-s -w -extldflags '-static' \
              -X github.com/aicli/aicli-web/pkg/version.Version=${{ steps.build-info.outputs.version }} \
              -X github.com/aicli/aicli-web/pkg/version.BuildTime=${{ steps.build-info.outputs.build_time }} \
              -X github.com/aicli/aicli-web/pkg/version.GitCommit=${{ steps.build-info.outputs.commit }} \
              -X github.com/aicli/aicli-web/pkg/version.GitBranch=${{ steps.build-info.outputs.branch }}" \
            -o dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }} \
            ./cmd/aicli

          # API ì„œë²„ ë¹Œë“œ
          echo "Building aicli-api for ${{ matrix.goos }}-${{ matrix.goarch }}..."
          go build -v -trimpath \
            -ldflags "-s -w -extldflags '-static' \
              -X github.com/aicli/aicli-web/pkg/version.Version=${{ steps.build-info.outputs.version }} \
              -X github.com/aicli/aicli-web/pkg/version.BuildTime=${{ steps.build-info.outputs.build_time }} \
              -X github.com/aicli/aicli-web/pkg/version.GitCommit=${{ steps.build-info.outputs.commit }} \
              -X github.com/aicli/aicli-web/pkg/version.GitBranch=${{ steps.build-info.outputs.branch }}" \
            -o dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }} \
            ./cmd/api

      - name: ë°”ì´ë„ˆë¦¬ ìµœì í™”
        if: matrix.goos != 'windows'
        run: |
          # Linux/macOSì—ì„œë§Œ strip ì‹¤í–‰
          if [ "${{ matrix.goos }}" = "linux" ]; then
            strip dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }}
            strip dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }}
          elif [ "${{ matrix.goos }}" = "darwin" ]; then
            # macOSì—ì„œëŠ” í¬ë¡œìŠ¤ ì»´íŒŒì¼ ì‹œ stripì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŒ
            if [ "${{ matrix.goarch }}" = "$(uname -m | sed 's/x86_64/amd64/')" ]; then
              strip dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }} || true
              strip dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }} || true
            fi
          fi
          
          # íŒŒì¼ í¬ê¸° í™•ì¸
          echo "Optimized binary sizes:"
          ls -lh dist/

      - name: UPX ì••ì¶• (ì„ íƒì )
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: |
          # UPX ì„¤ì¹˜
          wget -q https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          ./upx-4.2.2-amd64_linux/upx --version
          
          # ë°”ì´ë„ˆë¦¬ ì••ì¶• (ë°±ì—… ìƒì„±)
          cp dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }} dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }}.uncompressed
          cp dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }} dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }}.uncompressed
          
          # UPX ì••ì¶• ì ìš©
          ./upx-4.2.2-amd64_linux/upx --best --lzma dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }} || true
          ./upx-4.2.2-amd64_linux/upx --best --lzma dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }} || true
          
          # ì••ì¶• í›„ í¬ê¸° ë¹„êµ
          echo "Compression results:"
          ls -lh dist/
          
          # ì •ë¦¬
          rm -rf upx-* dist/*.uncompressed

      - name: ë¹Œë“œ ê²€ì¦
        run: |
          echo "Verifying built binaries..."
          
          # í˜„ì¬ í”Œë«í¼ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•œ ë°”ì´ë„ˆë¦¬ë§Œ í…ŒìŠ¤íŠ¸
          current_os="${{ runner.os }}"
          current_arch="$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/')"
          
          if [[ "$current_os" == "Linux" && "${{ matrix.goos }}" == "linux" && "${{ matrix.goarch }}" == "$current_arch" ]] || \
             [[ "$current_os" == "macOS" && "${{ matrix.goos }}" == "darwin" && "${{ matrix.goarch }}" == "$current_arch" ]] || \
             [[ "$current_os" == "Windows" && "${{ matrix.goos }}" == "windows" && "${{ matrix.goarch }}" == "amd64" ]]; then
            
            echo "Testing on native platform..."
            
            # CLI ë°”ì´ë„ˆë¦¬ í…ŒìŠ¤íŠ¸
            if [[ "${{ matrix.goos }}" == "windows" ]]; then
              ./dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }}.exe version
              ./dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }}.exe --version
            else
              chmod +x ./dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }}
              chmod +x ./dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }}
              ./dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }} version
              ./dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }} --version
            fi
          else
            echo "Cross-compiled binary - skipping execution test"
            # ìµœì†Œí•œ íŒŒì¼ì´ ì¡´ì¬í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œì§€ í™•ì¸
            if [[ "${{ matrix.goos }}" == "windows" ]]; then
              test -f ./dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }}.exe
              test -f ./dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }}.exe
            else
              test -f ./dist/aicli-${{ matrix.goos }}-${{ matrix.goarch }}
              test -f ./dist/aicli-api-${{ matrix.goos }}-${{ matrix.goarch }}
            fi
          fi

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*
          retention-days: 7
          if-no-files-found: error

  collect-artifacts:
    name: Collect All Artifacts
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binaries-*
          merge-multiple: true

      - name: ì•„í‹°íŒ©íŠ¸ ëª©ë¡ ìƒì„±
        run: |
          cd artifacts
          echo "# Build Artifacts" > artifacts-list.md
          echo "" >> artifacts-list.md
          echo "| Platform | Architecture | CLI Binary | API Binary | Size |" >> artifacts-list.md
          echo "|----------|--------------|------------|------------|------|" >> artifacts-list.md
          
          for file in aicli-*; do
            if [[ ! $file =~ "api" ]]; then
              platform=$(echo $file | cut -d'-' -f2)
              arch=$(echo $file | cut -d'-' -f3 | sed 's/\.exe$//')
              cli_size=$(ls -lh $file | awk '{print $5}')
              api_file="aicli-api-${platform}-${arch}"
              [[ $platform == "windows" ]] && api_file="${api_file}.exe"
              api_size=$(ls -lh $api_file 2>/dev/null | awk '{print $5}' || echo "N/A")
              echo "| $platform | $arch | $file | $api_file | CLI: $cli_size / API: $api_size |" >> artifacts-list.md
            fi
          done
          
          cat artifacts-list.md

      - name: í†µí•© ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: all-binaries
          path: |
            artifacts/*
            artifacts/artifacts-list.md
          retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Go í™˜ê²½ ì„¤ì •
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: gosec ë³´ì•ˆ ìŠ¤ìº”
        uses: securecodewarrior/gosec-action@v1.0.0
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'

      - name: ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gosec-results.sarif

  check-pr:
    name: PR Status Check
    runs-on: ubuntu-latest
    needs: [lint, test, build, security-scan, collect-artifacts]
    if: always()
    steps:
      - name: PR ìƒíƒœ ì²´í¬
        run: |
          echo "# ğŸ” CI Pipeline Summary"
          echo ""
          echo "## ğŸ“Š Pipeline Status"
          echo "| Stage | Status |"
          echo "|-------|--------|"
          echo "| Lint | ${{ needs.lint.result }} |"
          echo "| Test | ${{ needs.test.result }} |"
          echo "| Build | ${{ needs.build.result }} |"
          echo "| Security | ${{ needs.security-scan.result }} |"
          echo "| Artifacts | ${{ needs.collect-artifacts.result }} |"
          echo ""
          
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "## âŒ CI íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨"
            echo ""
            echo "ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:"
            [ "${{ needs.lint.result }}" != "success" ] && echo "- Lint: ${{ needs.lint.result }}"
            [ "${{ needs.test.result }}" != "success" ] && echo "- Test: ${{ needs.test.result }}"
            [ "${{ needs.build.result }}" != "success" ] && echo "- Build: ${{ needs.build.result }}"
            [ "${{ needs.security-scan.result }}" != "success" ] && echo "- Security: ${{ needs.security-scan.result }}"
            exit 1
          else
            echo "## âœ… CI íŒŒì´í”„ë¼ì¸ ì„±ê³µ"
            echo ""
            echo "ëª¨ë“  ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "### ğŸ¯ ë‹¤ìŒ ë‹¨ê³„"
            echo "- ì½”ë“œ ë¦¬ë·° ìš”ì²­"
            echo "- ë¨¸ì§€ ì¤€ë¹„ ì™„ë£Œ"
          fi

      - name: ë¹Œë“œ ì‹œê°„ ë¶„ì„
        if: success()
        run: |
          echo ""
          echo "## â±ï¸ Build Performance"
          echo ""
          echo "ë©€í‹° í”Œë«í¼ ë¹Œë“œê°€ ë³‘ë ¬ë¡œ ì‹¤í–‰ë˜ì–´ ì „ì²´ ë¹Œë“œ ì‹œê°„ì´ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo ""
          echo "### ì§€ì› í”Œë«í¼:"
          echo "- Linux (amd64, arm64)"
          echo "- macOS (amd64, arm64)"
          echo "- Windows (amd64)"

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Go í™˜ê²½ ì„¤ì •
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          go test -bench=. -benchmem -count=3 -run=^$ ./... | tee benchmark.txt

      - name: ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼ ì €ì¥
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: benchmark.txt
          retention-days: 30